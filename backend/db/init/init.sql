-- ============================================================================
-- OMAHA SYSTEM DATABASE: FULL INITIALIZATION SCRIPT
-- Dialect: SQLite
-- ============================================================================

PRAGMA foreign_keys = ON;
BEGIN TRANSACTION;

-- ============================================================================
-- 1. DROP EXISTING TABLES (Clean Slate)
-- ============================================================================
DROP TABLE IF EXISTS care_intervention;
DROP TABLE IF EXISTS outcome_score;
DROP TABLE IF EXISTS client_problem_symptom;
DROP TABLE IF EXISTS client_problem;
DROP TABLE IF EXISTS client_consent;
DROP TABLE IF EXISTS client_pii;
DROP TABLE IF EXISTS client;
DROP TABLE IF EXISTS outcome_phase;
DROP TABLE IF EXISTS intervention_category;
DROP TABLE IF EXISTS modifier_subject;
DROP TABLE IF EXISTS modifier_status;
DROP TABLE IF EXISTS intervention_target;
DROP TABLE IF EXISTS symptom;
DROP TABLE IF EXISTS omaha_problem;
DROP TABLE IF EXISTS omaha_domain;

-- ============================================================================
-- 2. SCHEMA DEFINITION
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 2.1 STATIC LOOKUP TABLES (Taxonomy)
-- ----------------------------------------------------------------------------

CREATE TABLE omaha_domain (
    domain_id INTEGER PRIMARY KEY,
    name TEXT NOT NULL UNIQUE
);

CREATE TABLE omaha_problem (
    problem_id INTEGER PRIMARY KEY,
    domain_id INTEGER NOT NULL,
    name TEXT NOT NULL,
    FOREIGN KEY (domain_id) REFERENCES omaha_domain(domain_id) ON DELETE RESTRICT
);

CREATE TABLE symptom (
    symptom_id INTEGER PRIMARY KEY AUTOINCREMENT,
    problem_id INTEGER NOT NULL,
    description TEXT NOT NULL,
    FOREIGN KEY (problem_id) REFERENCES omaha_problem(problem_id) ON DELETE CASCADE
);

CREATE TABLE intervention_target (
    target_id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE
);

CREATE TABLE modifier_status (
    status_id INTEGER PRIMARY KEY,
    name TEXT NOT NULL UNIQUE 
);

CREATE TABLE modifier_subject (
    subject_id INTEGER PRIMARY KEY,
    name TEXT NOT NULL UNIQUE 
);

CREATE TABLE intervention_category (
    category_id INTEGER PRIMARY KEY,
    name TEXT NOT NULL UNIQUE 
);

CREATE TABLE outcome_phase (
    phase_id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE
);

-- ----------------------------------------------------------------------------
-- 2.2 DYNAMIC DATA TABLES (GDPR Compliant)
-- ----------------------------------------------------------------------------

-- Client Core (Anonymized ID holder)
CREATE TABLE client (
    client_id INTEGER PRIMARY KEY AUTOINCREMENT,
    client_uuid TEXT NOT NULL UNIQUE, -- Generated by Backend (UUID v4)
    is_active INTEGER DEFAULT 1,      -- 1=Active, 0=Archived
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL
);

-- Client PII (Sensitive - Strict Access Control)
CREATE TABLE client_pii (
    client_pii_id INTEGER PRIMARY KEY AUTOINCREMENT,
    client_id INTEGER NOT NULL UNIQUE,
    first_name TEXT NOT NULL, -- Application must Encrypt
    last_name TEXT NOT NULL,  -- Application must Encrypt
    date_of_birth TEXT NOT NULL,
    email TEXT,
    address TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (client_id) REFERENCES client(client_id) ON DELETE CASCADE
);

-- Consent Tracking
CREATE TABLE client_consent (
    consent_id INTEGER PRIMARY KEY AUTOINCREMENT,
    client_id INTEGER NOT NULL,
    consent_type TEXT NOT NULL, -- e.g. 'DATA_PROCESSING'
    has_consented INTEGER NOT NULL, 
    ip_address TEXT,
    granted_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    revoked_at DATETIME DEFAULT NULL,
    FOREIGN KEY (client_id) REFERENCES client(client_id) ON DELETE CASCADE
);

-- Client Problem (The Anchor)
CREATE TABLE client_problem (
    client_problem_id INTEGER PRIMARY KEY AUTOINCREMENT,
    client_id INTEGER NOT NULL,
    problem_id INTEGER NOT NULL,
    status_id INTEGER NOT NULL, 
    subject_id INTEGER NOT NULL,
    active INTEGER DEFAULT 1, 
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (client_id) REFERENCES client(client_id) ON DELETE CASCADE,
    FOREIGN KEY (problem_id) REFERENCES omaha_problem(problem_id),
    FOREIGN KEY (status_id) REFERENCES modifier_status(status_id),
    FOREIGN KEY (subject_id) REFERENCES modifier_subject(subject_id)
);

-- Selected Symptoms (For 'Actual' problems)
CREATE TABLE client_problem_symptom (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    client_problem_id INTEGER NOT NULL,
    symptom_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (client_problem_id) REFERENCES client_problem(client_problem_id) ON DELETE CASCADE,
    FOREIGN KEY (symptom_id) REFERENCES symptom(symptom_id)
);

-- Outcome Scores (K-B-S Ratings 1-5)
CREATE TABLE outcome_score (
    score_id INTEGER PRIMARY KEY AUTOINCREMENT,
    client_problem_id INTEGER NOT NULL,
    phase_id INTEGER NOT NULL,
    rating_knowledge INTEGER CHECK(rating_knowledge BETWEEN 1 AND 5),
    rating_behavior INTEGER CHECK(rating_behavior BETWEEN 1 AND 5),
    rating_status INTEGER CHECK(rating_status BETWEEN 1 AND 5),
    date_recorded DATETIME DEFAULT CURRENT_TIMESTAMP, 
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,    
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,    
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (client_problem_id) REFERENCES client_problem(client_problem_id) ON DELETE CASCADE,
    FOREIGN KEY (phase_id) REFERENCES outcome_phase(phase_id)
);

-- Care Interventions
CREATE TABLE care_intervention (
    intervention_id INTEGER PRIMARY KEY AUTOINCREMENT,
    client_problem_id INTEGER NOT NULL,
    category_id INTEGER NOT NULL,
    target_id INTEGER NOT NULL,
    specific_details TEXT, 
    date_performed DATETIME DEFAULT CURRENT_TIMESTAMP, 
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,     
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,     
    deleted_at DATETIME DEFAULT NULL,
    FOREIGN KEY (client_problem_id) REFERENCES client_problem(client_problem_id) ON DELETE CASCADE,
    FOREIGN KEY (category_id) REFERENCES intervention_category(category_id),
    FOREIGN KEY (target_id) REFERENCES intervention_target(target_id)
);

-- ----------------------------------------------------------------------------
-- 2.3 TRIGGERS (Auto-Update Timestamps)
-- ----------------------------------------------------------------------------

CREATE TRIGGER idx_client_updated AFTER UPDATE ON client BEGIN
    UPDATE client SET updated_at = CURRENT_TIMESTAMP WHERE client_id = OLD.client_id;
END;
CREATE TRIGGER idx_client_pii_updated AFTER UPDATE ON client_pii BEGIN
    UPDATE client_pii SET updated_at = CURRENT_TIMESTAMP WHERE client_pii_id = OLD.client_pii_id;
END;
CREATE TRIGGER idx_client_problem_updated AFTER UPDATE ON client_problem BEGIN
    UPDATE client_problem SET updated_at = CURRENT_TIMESTAMP WHERE client_problem_id = OLD.client_problem_id;
END;
CREATE TRIGGER idx_cp_symptom_updated AFTER UPDATE ON client_problem_symptom BEGIN
    UPDATE client_problem_symptom SET updated_at = CURRENT_TIMESTAMP WHERE id = OLD.id;
END;
CREATE TRIGGER idx_outcome_score_updated AFTER UPDATE ON outcome_score BEGIN
    UPDATE outcome_score SET updated_at = CURRENT_TIMESTAMP WHERE score_id = OLD.score_id;
END;
CREATE TRIGGER idx_care_intervention_updated AFTER UPDATE ON care_intervention BEGIN
    UPDATE care_intervention SET updated_at = CURRENT_TIMESTAMP WHERE intervention_id = OLD.intervention_id;
END;


-- ============================================================================
-- 3. DATA SEEDING (THE OMAHA TAXONOMY)
-- ============================================================================

-- 3.1 DOMAINS (Exactly 4)
INSERT INTO omaha_domain (domain_id, name) VALUES 
(1, 'Environmental'),
(2, 'Psychosocial'),
(3, 'Physiological'),
(4, 'Health-related Behaviors');

-- 3.2 PROBLEMS (Exactly 42)
-- Domain 1: Environmental
INSERT INTO omaha_problem (problem_id, domain_id, name) VALUES 
(1, 1, 'Income'),
(2, 1, 'Sanitation'),
(3, 1, 'Residence'),
(4, 1, 'Neighborhood/workplace safety');

-- Domain 2: Psychosocial
INSERT INTO omaha_problem (problem_id, domain_id, name) VALUES 
(5, 2, 'Communication with community resources'),
(6, 2, 'Social contact'),
(7, 2, 'Role change'),
(8, 2, 'Interpersonal relationship'),
(9, 2, 'Spirituality'),
(10, 2, 'Grief'),
(11, 2, 'Mental health'),
(12, 2, 'Sexuality'),
(13, 2, 'Caretaking/parenting'),
(14, 2, 'Neglect'),
(15, 2, 'Abuse'),
(16, 2, 'Growth and development');

-- Domain 3: Physiological
INSERT INTO omaha_problem (problem_id, domain_id, name) VALUES 
(17, 3, 'Hearing'),
(18, 3, 'Vision'),
(19, 3, 'Speech and language'),
(20, 3, 'Oral health'),
(21, 3, 'Cognition'),
(22, 3, 'Pain'),
(23, 3, 'Consciousness'),
(24, 3, 'Integument'),
(25, 3, 'Neuro-musculo-skeletal function'),
(26, 3, 'Respiration'),
(27, 3, 'Circulation'),
(28, 3, 'Digestion-hydration'),
(29, 3, 'Bowel function'),
(30, 3, 'Genito-urinary function'),
(31, 3, 'Pregnancy'),
(32, 3, 'Postpartum'),
(33, 3, 'Communicable/infectious condition');

-- Domain 4: Health-related Behaviors
INSERT INTO omaha_problem (problem_id, domain_id, name) VALUES 
(34, 4, 'Nutrition'),
(35, 4, 'Sleep and rest patterns'),
(36, 4, 'Physical activity'),
(37, 4, 'Personal care'),
(38, 4, 'Substance use'),
(39, 4, 'Family planning'),
(40, 4, 'Health care supervision'),
(41, 4, 'Medication regimen'),
(42, 4, 'Technical procedure');

-- 3.3 SYMPTOMS (Standard Signs/Symptoms for Key Problems)
-- Note: This matches your input list.
INSERT INTO symptom (problem_id, description) VALUES 
(1, 'Low/no income'), (1, 'Difficulty buying essentials'), (1, 'Difficulty paying bills'), (1, 'Able to buy only essentials'),
(2, 'Soiled living area'), (2, 'Inadequate food storage/disposal'), (2, 'Insects/rodents'), (2, 'Foul odors'), (2, 'Inadequate water supply'), (2, 'Inadequate sewage disposal'),
(3, 'Structurally unsound'), (3, 'Inadequate heating/cooling'), (3, 'Steep stairs/no handrails'), (3, 'Cluttered living space'), (3, 'Unsafe mats/rugs'), (3, 'Inadequate lighting'), (3, 'Unsafe lead content'), (3, 'Homeless'),
(4, 'High crime rate'), (4, 'High pollution level'), (4, 'Uncontrolled animals'), (4, 'Physical hazards'), (4, 'Unsafe play area'),
(5, 'Unfamiliar with options/procedures'), (5, 'Difficulty understanding roles/regulations'), (5, 'Unable to communicate concerns'), (5, 'Dissatisfaction with services'), (5, 'Language barrier'), (5, 'Inadequate transportation'),
(6, 'Limited social contact'), (6, 'Minimal outside stimulation'), (6, 'Social isolation'),
(7, 'Inability to assume new role'), (7, 'Loss of previous role'), (7, 'Role conflict'), (7, 'Prolonged grief/guilt'),
(8, 'Difficulty establishing/maintaining relationships'), (8, 'Minimal shared activities'), (8, 'Inappropriate behavior'), (8, 'Domestic violence'),
(9, 'Spiritual distress'), (9, 'Disruption of religious practice'), (9, 'Value/belief conflict'),
(10, 'Difficulty coping with loss'), (10, 'Denial'), (10, 'Anger'), (10, 'Despair'), (10, 'Guilt'),
(11, 'Anxiety'), (11, 'Depression'), (11, 'Somatic complaints'), (11, 'Difficulty managing stress'), (11, 'Confusion'), (11, 'Flat affect'), (11, 'Agitation'), (11, 'Hallucinations/Delusions'),
(12, 'Sexual functioning difficulty'), (12, 'Dissatisfaction with sexual relationship'), (12, 'Inappropriate sexual behavior'),
(13, 'Difficulty providing physical care'), (13, 'Difficulty providing emotional support'), (13, 'Expectations incongruent with stage of growth'), (13, 'Dissatisfaction with responsibility'), (13, 'Neglectful/abusive'),
(14, 'Lack of physical necessities'), (14, 'Lack of emotional support'), (14, 'Lack of supervision'), (14, 'Evidence of physical neglect'),
(15, 'Physical abuse'), (15, 'Emotional abuse'), (15, 'Sexual abuse'), (15, 'Financial exploitation'),
(16, 'Abnormal weight/height'), (16, 'Failure to thrive'), (16, 'Developmental delay'), (16, 'Precocious development'),
(17, 'Difficulty hearing normal speech'), (17, 'Difficulty hearing distinct sounds'), (17, 'Use of hearing aid'), (17, 'Tinnitus'),
(18, 'Difficulty seeing near/far'), (18, 'Blurring'), (18, 'Double vision'), (18, 'Tearing/discharge'), (18, 'Blindness'),
(19, 'Difficulty expressing ideas'), (19, 'Difficulty understanding speech'), (19, 'Inappropriate speech'), (19, 'Slurred speech'), (19, 'Aphasia'),
(20, 'Toothache/pain'), (20, 'Decayed/missing teeth'), (20, 'Inflamed/bleeding gums'), (20, 'Ill-fitting dentures'), (20, 'Halitosis'),
(21, 'Memory loss'), (21, 'Disorientation'), (21, 'Poor judgment'), (21, 'Inability to reason'), (21, 'Short attention span'),
(22, 'Reports pain'), (22, 'Guarding behavior'), (22, 'Restlessness'), (22, 'Facial grimacing'), (22, 'Pallor/sweating'),
(23, 'Lethargic'), (23, 'Unresponsive'), (23, 'Comatose'), (23, 'Seizures'),
(24, 'Lesion/wound'), (24, 'Rash'), (24, 'Dryness/itching'), (24, 'Bruising'), (24, 'Inflammation'), (24, 'Drainage'),
(25, 'Limited range of motion'), (25, 'Weakness'), (25, 'Tremors'), (25, 'Atrophy'), (25, 'Poor coordination'), (25, 'Poor balance'), (25, 'Gait deviation'),
(26, 'Abnormal breath sounds'), (26, 'Shortness of breath'), (26, 'Cough'), (26, 'Cyanosis'), (26, 'Abnormal rate/rhythm'), (26, 'Oxygen dependence'),
(27, 'Edema'), (27, 'Cramping/pain'), (27, 'Temperature change in extremities'), (27, 'Discoloration'), (27, 'Varicosities'), (27, 'Abnormal pulse/BP'), (27, 'Angina'),
(28, 'Nausea/vomiting'), (28, 'Heartburn'), (28, 'Dysphagia'), (28, 'Dehydration'), (28, 'Anorexia'), (28, 'Jaundice'), (28, 'Ascites'),
(29, 'Constipation'), (29, 'Diarrhea'), (29, 'Incontinence'), (29, 'Blood in stool'), (29, 'Painful defecation'), (29, 'Ostomy'),
(30, 'Incontinence'), (30, 'Urgency/frequency'), (30, 'Burning/pain'), (30, 'Retention'), (30, 'Hematuria'), (30, 'Discharge'),
(31, 'Lochia abnormality'), (31, 'Fundal abnormality'), (31, 'Breast engorgement'), (31, 'Pain/tenderness'), (31, 'Infection signs'),
(32, 'Fever'), (32, 'Positive culture/test'), (32, 'Exposure to infectious disease'), (32, 'Drainage/secretion'),
(33, 'Obesity'), (33, 'Underweight'), (33, 'Unbalanced diet'), (33, 'Excessive intake'), (33, 'Inadequate intake'),
(34, 'Insomnia'), (34, 'Nightmares'), (34, 'Sleep apnea'), (34, 'Fatigue'), (34, 'Frequent waking'),
(35, 'Sedentary lifestyle'), (35, 'Excessive activity'), (35, 'Inappropriate type of activity'), (35, 'Lack of exercise routine'),
(36, 'Unable to bathe self'), (36, 'Unable to dress self'), (36, 'Unable to groom self'), (36, 'Poor hygiene'), (36, 'Unable to feed self'),
(37, 'Alcohol abuse'), (37, 'Drug abuse'), (37, 'Tobacco use'), (37, 'Dependence'), (37, 'Withdrawal symptoms'),
(38, 'Unwanted pregnancy'), (38, 'Infertility'), (38, 'Lack of contraception knowledge'), (38, 'Improper use of contraception'),
(39, 'Routine checkups missed'), (39, 'Immunizations incomplete'), (39, 'Failure to follow treatment plan'), (39, 'Unable to navigate health system'),
(40, 'Failure to take meds'), (40, 'Taking incorrect dose'), (40, 'Taking expired meds'), (40, 'Storing meds improperly'), (40, 'Side effects'),
(41, 'Difficulty performing procedure'), (41, 'Improper technique'), (41, 'Fear of procedure'), (41, 'Refusal to perform');


-- 3.4 INTERVENTION TARGETS (Exactly 75 Targets - Alphabetical)
-- Note: Added missing targets to reach 75.
INSERT INTO intervention_target (name) VALUES 
('Anatomy/physiology'),
('Behavior modification'),
('Bladder care'),
('Blood glucose monitoring'),
('Bonding/attachment'),
('Bowel care'),
('Cardiac care'),
('Cast care'),
('Communication'),
('Coping skills'),
('Day care/respite'),
('Dietary management'),
('Discipline'),
('Dressing change/wound care'),
('Durable medical equipment'),
('Education'),
('Emergency planning'),
('Employment'),
('Environment'),
('Exercises'),
('Family planning care'),
('Feeding procedures'),
('Finances'),
('Fluid intake'),
('Gait training'),
('Growth/development care'),
('Health care supervision'),
('Hearing care'),
('Homemaking'),
('Hospice/palliative care'),
('Infection control'),
('Injection administration'),
('Interaction'),
('Laboratory findings'),
('Legal system'),
('Medical/dental care'),
('Medication action/side effects'),
('Medication administration'),
('Medication set-up'),
('Mobility/transferring'),
('Nursing care, supplementary'),
('Nutritionist'),
('Occupational therapy'),
('Ostomy care'),
('Other community resource'),
('Pain control'),
('Personal care'),
('Physical therapy'),
('Positioning'),
('Range of motion'),
('Recreational therapy'),
('Relaxation/breathing techniques'),
('Rest/sleep'),
('Safety'),
('Screening'),
('Seizure precautions'),
('Signs/symptoms-mental/emotional'),
('Signs/symptoms-physical'),
('Skin care'),
('Social work/counseling'),
('Specimen collection'),
('Speech and language pathology'),
('Spiritual care'),
('Stimulation/nurturance'),
('Stress management'),
('Substance use cessation'),
('Supplies'),
('Support group'),
('Support system'),
('Technological equipment'),
('Tobacco use cessation'),
('Transportation'),
('Urinary catheter care'),
('Vision care'),
('Wellness'),
('Wound care');

-- 3.5 MODIFIERS
INSERT INTO modifier_status (status_id, name) VALUES 
(1, 'Actual'), (2, 'Potential'), (3, 'Health Promotion');

INSERT INTO modifier_subject (subject_id, name) VALUES 
(1, 'Individual'), (2, 'Family'), (3, 'Community');

-- 3.6 INTERVENTION CATEGORIES
INSERT INTO intervention_category (category_id, name) VALUES 
(1, 'Teaching, Guidance, and Counseling'),
(2, 'Treatments and Procedures'),
(3, 'Case Management'),
(4, 'Surveillance');

-- 3.7 OUTCOME PHASES
INSERT INTO outcome_phase (phase_id, name) VALUES
(1, 'Admission'),
(2, 'Interim'),
(3, 'Discharge');

COMMIT;
